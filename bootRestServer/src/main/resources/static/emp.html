<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <link rel="icon" href="./images/favicon.png" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>

	<!-- CSS only -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<script type="text/javascript" >
    let url = "http://localhost:9090";
	$(function(){
		jobList();
		
		userList();

		userSelect();
		
		userDelete();
		
		userInsert();
	
		userUpdate();
		
		init();
	});
	
	//초기화
	function init() {
		//초기화 버튼 클릭
		$('#btnInit').on('click',function(){
			$('#form1').each(function(){
				this.reset();
			});
		});
	}//init
	
	//사용자 삭제 요청
	function userDelete() {
		//삭제 버튼 클릭
		$('body').on('click','#btnDelete',function(){
			var employeeId = $(this).closest('tr').find('#hidden_employeeId').val();
			var result = confirm(employeeId +" 사용자를 정말로 삭제하시겠습니까?");
			if(result) {
				$.ajax({
					url: `${url}/emp/${employeeId}`,  
					type:'DELETE',
					contentType:'application/json;charset=utf-8',
					dataType:'text',
					error:function(xhr,status,msg){
						console.log("상태값 :" + status + " Http에러메시지 :"+msg);
					}, 
					success:function(result) {
						if(result) {
							alert("삭제완료");
							userList();
						} else {
							alert("삭제오류")
						}
					}
				});      }//if
		}); //삭제 버튼 클릭
	}//userDelete
	
	//사용자 조회 요청
	function userSelect() {
		//조회 버튼 클릭
		$('body').on('click','#btnSelect',function(){
			var employeeId = $(this).closest('tr').find('#hidden_employeeId').val();
			//특정 사용자 조회
			$.ajax({
				url: `${url}/emp/${employeeId}`, 
				type:'GET',
				dataType:'json',
				error:function(xhr,status,msg){
					alert("상태값 :" + status + " Http에러메시지 :"+msg);
				},
				success:userSelectResult
			});
		}); //조회 버튼 클릭
	}//userSelect
	
	//사용자 조회 응답
	function userSelectResult(emp) {
		$('input:text[name="employeeId"]').val(emp.employeeId);
		$('input:text[name="firstName"]').val(emp.firstName);
		$('input:text[name="lastName"]').val(emp.lastName);
		$('input:text[name="email"]').val(emp.email);
		$('input[name="hireDate"]').val(emp.hireDate);
		$('select[name="jobId"]').val(emp.jobId).attr("selected", "selected");
	}//userSelectResult
	
	//사용자 수정 요청
	function userUpdate() {
		//수정 버튼 클릭
		$('#btnUpdate').on('click',function(){
			var employeeId = $('input:text[name="employeeId"]').val();
			$.ajax({ 
				url: `${url}/emp/${employeeId}`,  
			    type: 'PUT', 
			    dataType: 'text', 
			    data: JSON.stringify(makeParam()),
			    contentType: 'application/json',
			    success: function(result) { 
					if(result) {
						alert("수정완료");
						userList();
					} else {
						alert("수정오류")
					}
			    },
			    error:function(xhr, status, message) { 
			        alert(" status: "+status+" er:"+message);
			    }
			});
		});//수정 버튼 클릭
	}//userUpdate
	
	
	function makeParam(){
		var employeeId = $('input:text[name="employeeId"]').val();
		var firstName = $('input:text[name="firstName"]').val();
		var lastName = $('input:text[name="lastName"]').val();
		var hireDate = $('[name="hireDate"]').val();
		var jobId = $('select[name="jobId"]').val();	
		var email = $('input:text[name="email"]').val();	
		return {employeeId , firstName, lastName, hireDate ,jobId, email }	
	}
	//사용자 등록 요청
	function userInsert(){
		//등록 버튼 클릭
		$('#btnInsert').on('click',function(){

			$.ajax({ 
			    url: url + "/emp",  
			    type: 'POST',  
			    contentType : "application/json",
			    dataType: 'text', 
			    data: JSON.stringify(makeParam()),
			    success: function(result) {
					if(result) {
						alert("등록완료");
						userList();
					} else {
						alert("등록오류")
					}
			    }, 
			    error:function(xhr, status, message) { 
			        alert(" status: "+status+" er:"+message);
			    }
			 });
		});//등록 버튼 클릭
	}//userInsert
	
	
	//사용자 목록 조회 요청
	function userList() {
		$.ajax({
			url:'/emp',
			type:'GET',
			dataType:'json',
			error:function(xhr,status,msg){
				alert("상태값 :" + status + " Http에러메시지 :"+msg);
			},
			success: userListResult
		});
	}//userList
	
	//사용자 목록 조회 응답
	function userListResult(data) {
		$("tbody").empty();
		$.each(data,function(idx,item){
			$('<tr>')
			.append($('<td>').html(item.employeeId))
			.append($('<td>').html(item.firstName + " " + item.lastName))
			.append($('<td>').html(item.jobId))
			.append($('<td>').html('<button id=\'btnSelect\'>조회</button>'))
			.append($('<td>').html('<button id=\'btnDelete\'>삭제</button>'))
			.append($('<input type=\'hidden\' id=\'hidden_employeeId\'>').val(item.employeeId))
			.appendTo('tbody');
		});//each
	}//userListResult
	
	//job 옵션 조회 요청
	function jobList() {
		$.ajax({
			url:'/job',
			type:'GET',
			dataType:'json',
			error:function(xhr,status,msg){
				alert("상태값 :" + status + " Http에러메시지 :"+msg);
			},
			success: function(datas){
				datas.forEach(d => document.querySelector("#jobId").insertAdjacentHTML("beforeend", `<option value="${d.jobId}">${d.jobTitle}`))
			}
		});
	}//userList	
</script>

</head>
<body>s
<div class="container">
	<div class="row">
		<div class="col " >
			<h2>사원 목록</h2>
			<div class=" overflow-auto border" style="height: 700px;">
			<table class="table text-center">
				<thead>
					<tr>
						<th class="text-center">사번</th>
						<th class="text-center">이름</th>
						<th class="text-center">JOB</th>
						<th class="text-center"></th>
					</tr>
				</thead>
				
				<tbody>
					<tr>
						<td class="text-center">100</td>
						<td class="text-center">홍길동</td>
						<td class="text-center">PROGRAMER</td>
						<td class="text-center">
							<button class="btnUpd">조회</button>
							<button class="btnDel">삭제</button>
						</td>
					</tr>	
				</tbody>
			</table>
			</div>
		</div>
		
		<div class="col">
			<form id="form1" class="form-horizontal">
				<h2>사원 등록 및 수정</h2>
		<div class="border">
				<div class="form-group m-3">
					<label>사번:</label> <input type="text" class="form-control" readonly
						name="employeeId">
				</div>
				<div class="form-group m-3">
					<label>이름:</label> 
					<input type="text" class="form-control"	name="firstName" placeholder="firstName">
					<input type="text" class="form-control"	name="lastName" placeholder="lastName">
				</div>
				<div class="form-group m-3">
					<label>이메일:</label> 
					<input type="text" class="form-control" name="email">
				</div>
				<div class="form-group m-3">
					<label>입사일자:</label> 
					<input type="date" class="form-control" name="hireDate">
				</div>
				<div class="form-group m-3">
					<label>역할:</label> 
					<select class="form-control" name="jobId" id="jobId">
					    <option value="">선택</option>
					</select>
				</div>
				<div class="form-group m-2">
					<input type="button" class="btn btn-primary" value="등록" id="btnInsert" /> 
					<input type="button" class="btn btn-primary" value="수정" id="btnUpdate" /> 
					<input type="button" class="btn btn-primary" value="초기화" id="btnInit" />
				</div>
			</div>
			</form>
		</div>
	</div>
		
</div>

</body>
</html>